<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Oryx Robot — Interactive</title>
  <style>
    :root{ --blue:#243b4a; --orange:#f99f00 }
    html,body{ height:100%; margin:0; background:var(--blue); color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial }
    canvas{ display:block }
    #hud{
      position:fixed; left:10px; bottom:10px; background:rgba(0,0,0,.52);
      padding:10px 12px; border-radius:10px; font-size:.9em; border:1px solid rgba(255,255,255,.18)
    }
    #hud b{ color:var(--orange) }
  </style>
</head>
<body>
  <div id="hud">Initializing…</div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.126.0/build/three.module.js';
    import { GLTFLoader } from 'https://unpkg.com/three@0.126.0/examples/jsm/loaders/GLTFLoader.js';

    const HUD = document.getElementById('hud');
    const ROBOT_URL = './Eclipse_Sentinel_0813205056_texture.glb'; // تأكد أن الملف بجوار index.html

    // فحص سريع للرابط لمساعدة التشخيص
    try {
      const head = await fetch(ROBOT_URL, { method:'HEAD', cache:'no-store' });
      if (!head.ok) HUD.innerHTML = `❌ GLB not found (HTTP ${head.status})<br><b>${ROBOT_URL}</b>`;
      else HUD.innerHTML = `⏳ Preparing to load: <b>${ROBOT_URL}</b>`;
    } catch(e){ HUD.innerHTML = `❌ Preflight failed: ${e?.message||e}`; }

    // المشهد
    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setSize(innerWidth, innerHeight);
    renderer.outputEncoding = THREE.sRGBEncoding;           // r126 API
    renderer.toneMapping = THREE.ACESFilmicToneMapping;     // ألوان أفضل
    renderer.toneMappingExposure = 1.25;                    // سطوع أنسب
    document.body.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x243b4a);

    const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 100);
    camera.position.set(0, 1.6, 3);

    // إضاءة متناسقة مع ORYX
    const hemi = new THREE.HemisphereLight(0xffffff, 0x243b4a, 0.9);
    scene.add(hemi);
    const rim = new THREE.DirectionalLight(0xf99f00, 1.25);
    rim.position.set(2.0, 1.6, 1.3);
    scene.add(rim);
    const key = new THREE.DirectionalLight(0xffffff, 1.05);
    key.position.set(-1.6, 1.9, 2.3);
    scene.add(key);

    // تحميل الموديل
    const loader = new GLTFLoader();
    let robot, headBone=null, baseY=0, mx=0.5, my=0.5;

    HUD.textContent = '⏳ Loading: 0%';
    loader.load(
      ROBOT_URL,
      (gltf)=>{
        robot = gltf.scene;

        // تحسين الخامات واصطياد الرأس
        robot.traverse((o)=>{
          if (o.isMesh && o.material){
            if ('roughness' in o.material) o.material.roughness = 0.35;
            if ('metalness' in o.material) o.material.metalness = Math.min(0.9, (o.material.metalness ?? 0.6));
            if ('envMapIntensity' in o.material) o.material.envMapIntensity = 1.0;
          }
          if (!headBone && (o.isBone || o.type==='Bone') && /head|neck/i.test(o.name)) headBone = o;
        });

        // تمركز، تحجيم، ووضع القدمين على الأرض
        const box   = new THREE.Box3().setFromObject(robot);
        const size  = box.getSize(new THREE.Vector3());
        const center= box.getCenter(new THREE.Vector3());

        robot.position.sub(center);           // المركز عند الأصل
        const scale = 1.7 / (size.y || 1);    // ارتفاع ~1.7م
        robot.scale.setScalar(scale);

        const half = (size.y * scale) * 0.5;  // نصف الارتفاع بعد التحجيم
        robot.position.y += half;             // الأقدام عند y=0
        baseY = robot.position.y;             // نحفظ قاعدة الارتفاع لحركة التنفّس

        scene.add(robot);

        // تأطير الكاميرا ليملأ ~70% من الارتفاع
        const fitFrac = 0.70;                        // نسبة ملء الشاشة رأسيًا
        const targetH = (size.y * scale) / fitFrac;  // الارتفاع المراد عرضه
        const dist = (targetH * 0.5) / Math.tan(THREE.MathUtils.degToRad(camera.fov * 0.5));
        const midY = baseY * 0.95;
        camera.position.set(0, midY, Math.max(2.2, dist));
        camera.lookAt(0, midY, 0);

        HUD.innerHTML = `✅ Loaded — approx size: <b>${size.x.toFixed(2)}×${size.y.toFixed(2)}×${size.z.toFixed(2)} m</b>`;
      },
      (xhr)=>{
        const pct = xhr.total ? (xhr.loaded/xhr.total*100) : 0;
        HUD.innerHTML = `⏳ Loading: <b>${pct.toFixed(0)}%</b>`;
      },
      (err)=>{
        console.error(err);
        HUD.innerHTML = `❌ Error loading: <b>${ROBOT_URL}</b><br>${err?.message||err}`;
      }
    );

    // تفاعل الماوس
    addEventListener('mousemove', e=>{ mx = e.clientX/innerWidth; my = e.clientY/innerHeight; });

    // حلقة الرسم
    renderer.setAnimationLoop(()=>{
      if (robot){
        const t = performance.now()*0.001;

        // تنفّس حول baseY (بدون انزياح للأسفل)
        robot.position.y = baseY + Math.sin(t*1.2)*0.03;

        // ميلان الجسم
        const tiltX = (my - 0.5) * -0.15;
        const tiltY = (mx - 0.5) *  0.25;
        robot.rotation.x = THREE.MathUtils.lerp(robot.rotation.x, tiltX, 0.08);
        robot.rotation.y = THREE.MathUtils.lerp(robot.rotation.y, tiltY, 0.08);

        // نظرة الرأس
        if (headBone){
          headBone.rotation.y = THREE.MathUtils.lerp(headBone.rotation.y, (mx-0.5)*0.6, 0.15);
          headBone.rotation.x = THREE.MathUtils.lerp(headBone.rotation.x, (my-0.5)*-0.4, 0.15);
        }
      }
      renderer.render(scene, camera);
    });

    // تغيير المقاس
    addEventListener('resize', ()=>{
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });

    // اختبارات بسيطة
    console.assert(ROBOT_URL.startsWith('./'), '[TEST] ROBOT_URL should be relative for GitHub Project Pages.');
    console.assert(!!document.querySelector('canvas'), '[TEST] canvas mounted');
  </script>
</body>
</html>
